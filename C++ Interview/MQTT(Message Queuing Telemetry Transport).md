

# MQTT（Message Queuing Telemetry Transport）

MQTT（Message Queuing Telemetry Transport）是一种轻量级的、基于发布/订阅（publish-subscribe）模式的通信协议，专门设计用于资源有限的设备和低带宽、不可靠网络环境中的机器到机器（M2M）和物联网（IoT）通信。MQTT协议构建在TCP/IP之上，由IBM在1999年首次发布，并在OASIS组织标准化后得到全球范围内的广泛应用。

MQTT协议的主要特点包括：

**轻量级**: MQTT协议消息结构紧凑，降低了传输负载，非常适合低功耗、低带宽的设备。

**发布/订阅模型**: MQTT采用了发布/订阅模式，允许设备（发布者）将消息发布到特定的主题（topics），而其他设备（订阅者）可以订阅感兴趣的主题来接收消息。

**服务质量（QoS）**: MQTT支持三种不同的服务质量等级（Quality of Service levels），分别为0、1和2，分别对应至多一次、至少一次和精确一次的交付保证。

QoS 0：至多一次，消息可能丢失，但传输最快。
QoS 1：至少一次，保证消息至少会被接收一次，但有可能重复。
QoS 2：精确一次，确保消息只被接收一次，即使在网络中断的情况下也会尽力完成消息的可靠投递。
**持久会话**: MQTT支持客户端断开连接后再次连接时继续之前的会话状态，这意味着未完成的消息传输可以恢复。

**遗嘱消息（Last Will and Testament, LWT）**: 当设备意外断开连接时，MQTT可以设置一条遗嘱消息，由Broker在检测到设备离线时代为发布。

**Broker中心化**: MQTT协议中有一个核心角色——Broker（消息代理），负责接收、存储和转发消息。

**可扩展性**: MQTT协议允许自定义用户属性（User Properties），以携带额外的元数据，适应多样化的应用需求。

**广泛支持**: MQTT协议被众多物联网平台和设备支持，拥有丰富的客户端库，可在多种操作系统和编程语言环境下轻松实现。

MQTT协议在智能建筑、工业自动化、农业监测、智能家居、远程医疗等诸多物联网领域有着广泛的应用。由于其简洁有效、易于实现的特性，MQTT成为了当今物联网通信领域的主流协议之一。


# MQTT 5.0 和3.1 的区别

MQTT 5.0 相对于 MQTT 3.1.1 引入了许多改进和新特性，以下是一些关键区别点：

## 会话管理增强

MQTT 5.0 明确定义了持久性和非持久性会话，允许客户端指定是否希望在断开连接时保留会话状态，而 MQTT 3.1.1 中虽然也有类似机制，但表述和控制不如5.0明确。

## 消息属性

MQTT 5.0 引入了丰富的消息属性系统，允许在CONNECT、SUBSCRIBE、UNSUBSCRIBE、PUBLISH等消息中包含附加属性，如用户属性、响应信息、请求问题详情、消息_expiry_interval（有效期）、payload_format_indicator（载荷格式指示器）等。这些属性极大地增强了消息的语义表达能力和通信效率。

## 服务质量 QoS 改进

MQTT 5.0 对服务质量（QoS）级别进行了更细粒度的控制，允许在单个会话中动态更改主题的QoS级别。

## 错误处理和反馈

新增了错误码和响应报文中的原因码，这样当发生错误或拒绝时，服务端和客户端可以更准确地传达失败原因。

## 扩展协议灵活性

MQTT 5.0 提供了更多配置选项，允许客户端和服务端协商参数，如最大包大小、接收者是否愿意接收RETAIN消息等。

## Topic主题过滤器改进

MQTT 5.0 支持更为复杂的主题筛选器，包括通配符的改进以及对共享订阅的支持。

## 性能优化

通过引入新的控制包类型和属性，MQTT 5.0 可以更有效地处理*重连和离线期间积累的消息*。

